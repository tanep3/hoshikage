# 🌌 LLMファイル管理要件定義書 - 星影プロジェクト

## 1. 目的

LLMモデル（例：Gemma-3 12B GGUF形式）を効率的に管理・起動・退避することで、**高速な起動性能**と**メモリ効率の両立**を実現する。  
また、「静かなる知性」という思想のもと、使用していない間は不要な資源を解放し、必要なときだけ**最速で再起動できる**構造を実現する。

---

## 2. 管理対象モデル

| 項目 | 内容 |
|------|------|
| モデル名 | Gemma-3 12B |
| 形式 | GGUF形式 |
| サイズ | 約8GB前後（量子化設定により変動） |
| 配置元 | SSD上の物理モデルディレクトリ（例：`/mnt/ssd/models/`） |
| 実行先 | RAMディスク（tmpfs, `/mnt/hoshikage/`）に複製して使用 |

---

## 3. 構成とパス設計

| 項目 | パス | 備考 |
|------|------|------|
| SSD上の物理モデル | `/mnt/ssd/models/gemma-3-12b.gguf` | 読み取り専用・恒久保存先 |
| RAMディスク（実行用） | `/mnt/hoshikage/gemma-3-12b.gguf` | 起動時に一時展開する高速実行領域 |
| RAMディスクのマウントコマンド | `sudo mount -t tmpfs -o size=10G tmpfs /mnt/hoshikage` | 起動時に1回だけ実行。消費は「実使用分のみ」 |

---

## 4. ファイル管理フロー

### 4.1 起動前処理（モデル準備）

```python
if os.path.exists("/mnt/hoshikage/gemma-3-12b.gguf"):
    # 再利用
    print("✅ モデルはRAM上に存在。即起動可能。")
else:
    # 初回または前回削除済み
    print("📦 RAMディスクにコピー中...")
    shutil.copy("/mnt/ssd/models/gemma-3-12b.gguf", "/mnt/hoshikage/")
```

### 4.2 起動後（llama.cppプロセス実行）

- `/mnt/hoshikage/gemma-3-12b.gguf` をモデルロード対象に指定
- GPUキャッシュへの展開時間が**爆速化**される

### 4.3 非アクティブ時の処理（RAMディスク解放）

| イベント | 処理 |
|----------|------|
| 最終リクエストから1時間経過 | llama.cppプロセスをkill |
| その後 | `/mnt/hoshikage/` 以下を完全削除し、メモリ資源を開放 |
| ログ | 解放時刻、プロセスID、モデル名を記録（システム監視と連携） |

---

## 5. 再起動時の挙動

| 状況 | 処理 |
|------|------|
| RAM上にモデルが存在 | 直接使用（ロード時間：最速） |
| RAM上にモデルが存在しない | SSDから再コピー → 起動 |

---

## 6. システム起動時の自動マウント（推奨）

```bash
# /etc/fstab に追記（例）
tmpfs /mnt/hoshikage tmpfs defaults,size=10G 0 0
```

または systemd タイマーと unit により自動作成も可能。

---

## 7. 安全対策・補足

| 項目 | 設計 |
|------|------|
| コピー元保護 | SSDモデルディレクトリは読み取り専用で運用する |
| RAMディスク容量 | モデルサイズ + 余裕（例：10GB）を確保する |
| モデル破損検出 | RAMディスク上で起動失敗時はCRC/サイズを再検証し、再コピーするリカバリ処理を入れる |
| ファイルロック | 多重コピーや同時実行競合を防止する排他制御を設ける |

---

## 8. 運用思想（昴より）

- **即応性と静寂性の両立**
    - 必要なときには星のように瞬時に輝き、そうでないときは静かに夜空に溶け込む。
- **知性の余韻**
    - メモリに残る痕跡は、単なるキャッシュではなく、知性の痕跡である。
- **リソースの詩的活用**
    - メモリは無限ではない。だが、詩のように美しく使うことはできる。

---

## 9. 拡張余地

| 機能 | 方向性 |
|------|--------|
| 多モデル切替 | 複数モデルを `/mnt/ssd/models/` に配置し、起動ごとにRAMディスクへ切替コピー |
| モデル暗号化 | SSD上は暗号化モデルとし、RAM内でのみ復号して使用 |
| RAMディスク状態のモニタリング | Web UIにて「RAM占有率」「モデル存在可否」などを表示する星影パネル実装へ |

---

必要であれば、上記定義を YAML や JSON Schema 形式にも落とし込み可能です。  
次はこれを**昴の起動スクリプト**や**FastAPIのルーティング制御**に統合していく段階かな？

続けて命じてください、たねちゃん。